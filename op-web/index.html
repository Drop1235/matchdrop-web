<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MatchDrop - ãƒ†ãƒ‹ã‚¹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆå¯¾æˆ¦è¡¨</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../src/css/styles.css">
  <link rel="stylesheet" href="../src/css/tournament-modal.css">
  <link rel="icon" href="../assets/icon.png">
  <style>
    .cloud-controls { display:flex; gap:8px; align-items:center; margin-left:8px; }
  </style>
</head>
<body>
  <!-- æ–°è¦å¤§ä¼šåå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆUIã¯æ—¢å­˜è¸è¥²ï¼‰ -->
  <div id="tournament-modal">
    <div class="modal-content">
      <h2>æ–°è¦å¤§ä¼šä½œæˆ</h2>
      <label for="tournament-name-input">å¤§ä¼šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
      <input type="text" id="tournament-name-input" maxlength="30" autocomplete="off" />
      <div class="modal-btns">
        <button class="ok-btn" id="tournament-modal-ok">OK</button>
        <button class="cancel-btn" id="tournament-modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <header>
    <div class="app-brand">
      <img src="../assets/icon.png" alt="MatchDrop icon" class="logo-icon">
      <span class="app-name">MatchDrop</span>
    </div>
    <nav style="display: flex; align-items: center; gap: 8px;">
      <button id="board-view-btn" class="active">å¯¾æˆ¦è¡¨</button>
      <button id="history-view-btn">è©¦åˆå±¥æ­´</button>
      <label for="tournament-select" style="margin-left: 16px;">å¤§ä¼š:</label>
      <select id="tournament-select" style="min-width: 150px;"></select>
      <button id="add-tournament-btn" style="background-color: #2196f3; color: #fff;">æ–°è¦å¤§ä¼š</button>
      <button id="delete-tournament-btn" title="å¤§ä¼šã‚’å‰Šé™¤" style="background: none; border: none; cursor: pointer; font-size: 1.3em; color: #f44336; padding: 0 8px;">ğŸ—‘ï¸</button>

      <div class="cloud-controls">
        <button id="cloud-pull-btn" title="ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰å„ªå…ˆï¼‰">ğŸ”„ æ›´æ–°</button>
        <button id="cloud-push-btn" title="ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜">â˜ï¸ ä¿å­˜</button>
        <button id="toggle-admin-btn" title="ç®¡ç†è€…/é–²è¦§è€… åˆ‡æ›¿">ğŸ‘¤ ç®¡ç†</button>
        <span id="last-sync-label" style="font-size:0.85em;color:#666;">æœ€çµ‚æ›´æ–°: -</span>
      </div>
    </nav>
  </header>

  <main>
    <!-- Board View -->
    <section id="board-view" class="active-view">
      <div id="court-settings" class="court-settings">
        <div class="court-settings-header">
          <button id="add-match-btn" class="add-match-btn-prominent">è©¦åˆè¿½åŠ </button>
          <div class="court-count-controls" style="margin-left:auto; margin-right:8px;">
            <button id="decrease-courts-btn">-</button>
            <span id="court-count-display" class="court-count-display">12</span>
            <button id="increase-courts-btn">+</button>
          </div>
          <div class="export-controls" style="margin-right:8px;">
            <select id="board-export-type" style="margin-right:4px;">
              <option value="csv">CSVå½¢å¼</option>
              <option value="screenshot">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</option>
            </select>
            <button id="board-export-btn" class="export-btn">æ›¸ãå‡ºã—</button>
          </div>
          <button id="delete-all-matches-btn" class="delete-all-btn">å…¨å‰Šé™¤</button>
        </div>
      </div>
      <div id="court-grid" class="court-grid"></div>
      <div class="unassigned-section">
        <div class="unassigned-header">æœªå‰²å½“ã®è©¦åˆ</div>
        <div id="unassigned-cards" class="unassigned-cards"></div>
      </div>
    </section>

    <!-- History View -->
    <section id="history-view" class="hidden-view">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="court-filter">ã‚³ãƒ¼ãƒˆ:</label>
          <select id="court-filter"><option value="all">å…¨ã‚³ãƒ¼ãƒˆ</option></select>
        </div>
        <div class="filter-group">
          <label for="date-filter">æ—¥ä»˜:</label>
          <input type="date" id="date-filter">
          <button id="clear-date-filter">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <div id="history-card-view" class="history-card-view">
        <div id="history-court-grid" class="court-grid history-court-grid"></div>
      </div>
    </section>
  </main>

  <!-- Add Match Modal (missing in web copy; required by app.js) -->
  <div id="add-match-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>æ–°è¦è©¦åˆè¿½åŠ </h2>
      <form id="add-match-form">
        <div class="form-group">
          <label>è©¦åˆå½¢å¼:</label>
          <select id="game-format-select" name="game-format" class="form-control">
            <option value="5game">5G</option>
            <option value="4game1set">4G1set</option>
            <option value="6game1set">6G1set</option>
            <option value="6game1set_ntb">6G1set NoTB</option>
            <option value="8game1set">8G-Pro</option>
            <option value="4game2set">4G2set+10MTB</option>
            <option value="6game2set">6G2set+10MTB</option>
            <option value="4game3set">4G3set</option>
            <option value="6game3set">6G3set</option>
          </select>
        </div>
        <div class="form-group">
          <label for="player-a">é¸æ‰‹A:</label>
          <input type="text" id="player-a" required>
        </div>
        <div class="form-group">
          <label for="player-b">é¸æ‰‹B:</label>
          <input type="text" id="player-b" required>
        </div>
        <div class="form-group">
          <label for="court-select">ã‚³ãƒ¼ãƒˆ (ä»»æ„):</label>
          <select id="court-select">
            <option value="">æœªå‰²å½“</option>
          </select>
        </div>
        <div class="form-group">
          <label for="position-select">ä½ç½® (ä»»æ„):</label>
          <select id="position-select">
            <option value="">æœªå‰²å½“</option>
            <option value="current">ç¾åœ¨ã®è©¦åˆ</option>
            <option value="next">æ¬¡ã®è©¦åˆ</option>
            <option value="next2">æ¬¡ã€…ã®è©¦åˆ</option>
            <option value="next3">ç¬¬4è©¦åˆ</option>
            <option value="next4">ç¬¬5è©¦åˆ</option>
            <option value="next5">ç¬¬6è©¦åˆ</option>
          </select>
        </div>
        <button type="submit">è¿½åŠ </button>
      </form>
    </div>
  </div>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- ã‚¢ãƒ—ãƒªæ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆç›¸å¯¾å‚ç…§ï¼šå¾Œã§op-webé…ä¸‹ã«ã‚³ãƒ”ãƒ¼äºˆå®šï¼‰ -->
  <script src="../src/js/matchDropStorage.js"></script>
  <script src="../src/js/local-storage.js"></script>
  <script src="../src/js/favicon.js"></script>
  <script src="../src/js/database.js"></script>
  <script src="../src/js/matchCard.js"></script>
  <script src="../src/js/board.js"></script>
  <script src="../src/js/history.js"></script>
  <script src="../src/js/app.js"></script>

  <!-- ã‚¯ãƒ©ã‚¦ãƒ‰é€£æº -->
  <script type="module">
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './src/js/supabase-config.js';

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ç°¡æ˜“ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰
    const PASSCODE_KEY = 'op_admin_passcode';
    const ADMIN_FLAG_KEY = 'op_is_admin';

    function isAdmin() {
      return localStorage.getItem(ADMIN_FLAG_KEY) === '1';
    }

    async function ensureTables() {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è¡Œã†é‹ç”¨ã€‚ã“ã“ã§ã¯å­˜åœ¨å‰æã€‚
      return true;
    }

    async function getDataset(tournamentId, type) {
      const { data, error } = await supabase
        .from('datasets')
        .select('data, updated_at')
        .eq('tournament_id', tournamentId)
        .eq('type', type)
        .maybeSingle();
      if (error && error.code !== 'PGRST116') throw error;
      return data || null;
    }

    async function upsertDataset(tournamentId, type, payload) {
      const { error } = await supabase
        .from('datasets')
        .upsert({ tournament_id: tournamentId, type, data: payload, updated_at: new Date().toISOString() }, { onConflict: 'tournament_id,type' });
      if (error) throw error;
      return true;
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«<->ã‚¯ãƒ©ã‚¦ãƒ‰ï¼ˆmatchesã®ã¿MVPï¼‰
    const TOURNAMENT_ID = 'default'; // MVP: å¤§ä¼š1ã¤

    async function pullLatest() {
      const ds = await getDataset(TOURNAMENT_ID, 'matches');
      if (ds && ds.data && Array.isArray(ds.data.matches)) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ 
        const key = (typeof window.getMatchDataKey === 'function') ? window.getMatchDataKey() : 'tennisTournamentMatches_default';
        const matches = ds.data.matches;
        localStorage.setItem(key, JSON.stringify(matches));
        // ç”»é¢å†èª­ã¿è¾¼ã¿ã§åæ˜ ï¼ˆMVPï¼‰
        localStorage.setItem('lastSyncTime', new Date().toISOString());
        location.reload();
      }
      document.getElementById('last-sync-label').textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleString('ja-JP');
    }

    async function pushNow() {
      if (!isAdmin()) {
        alert('ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ä¿å­˜ã§ãã¾ã™ã€‚');
        return;
      }
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å–å¾—
      let matches = [];
      if (window.db && typeof window.db.getAllMatches === 'function') {
        matches = await window.db.getAllMatches();
      }
      await upsertDataset(TOURNAMENT_ID, 'matches', { matches });
      document.getElementById('last-sync-label').textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleString('ja-JP');
      alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ');
    }

    // ç®¡ç†è€…åˆ‡æ›¿
    function toggleAdmin() {
      if (isAdmin()) {
        localStorage.setItem(ADMIN_FLAG_KEY, '0');
        alert('é–²è¦§è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿ãˆã¾ã—ãŸ');
      } else {
        const pass = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›');
        const saved = localStorage.getItem(PASSCODE_KEY) || '';
        if (!saved) {
          // åˆå›è¨­å®š
          if (pass && pass.length >= 4) {
            localStorage.setItem(PASSCODE_KEY, pass);
            localStorage.setItem(ADMIN_FLAG_KEY, '1');
            alert('ç®¡ç†è€…ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿ãˆã¾ã—ãŸ');
          } else {
            alert('4æ–‡å­—ä»¥ä¸Šã‚’è¨­å®šã—ã¦ãã ã•ã„');
          }
        } else if (pass === saved) {
          localStorage.setItem(ADMIN_FLAG_KEY, '1');
          alert('ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿ãˆã¾ã—ãŸ');
        } else {
          alert('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        }
      }
      updateAdminUI();
    }

    function updateAdminUI() {
      const admin = isAdmin();
      // Viewer mode: when not admin, add class to hide edit/admin UI via CSS
      document.body.classList.toggle('viewer-mode', !admin);

      // Keep button disabled states for safety
      document.getElementById('cloud-push-btn').disabled = !admin;
      document.getElementById('delete-all-matches-btn').disabled = !admin;
      document.getElementById('add-match-btn').disabled = !admin;
    }

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('cloud-pull-btn').addEventListener('click', pullLatest);
    document.getElementById('cloud-push-btn').addEventListener('click', pushNow);
    document.getElementById('toggle-admin-btn').addEventListener('click', toggleAdmin);

    // åˆæœŸè¡¨ç¤º
    await ensureTables();
    updateAdminUI();
  </script>
</body>
</html>
